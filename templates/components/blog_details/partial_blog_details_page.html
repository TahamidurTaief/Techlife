{% load static %}
{% load humanize %}
{% load custom_filters %}

<header data-aos="fade-up" data-aos-anchor-placement="top-bottom"
    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-12 sm:-mt-[30px]">
    <div class="flex items-center flex-wrap text-sm sm:text-base">
        <!-- Home Icon -->
        <i class="fa-solid fa-house text-gray-500 text-xs sm:text-sm"></i>

        <!-- Breadcrumb Items -->
        <span class="text-gray-600 pl-2 pr-1">Bangladesh</span>
        <span class="text-gray-600 mx-1">/</span>
        <a
            class="text-gray-600 hover:text-blue-600 cursor-pointer transition-colors duration-200 truncate max-w-[150px] sm:max-w-none">
            {{ blog_detail.category.name }}
        </a>
    </div>
</header>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-12">
    <div class="flex flex-col lg:flex-row lg:gap-8">
        <main class="w-full lg:w-3/4 blog-content-area">
            <div class="details">
                <div id="blog-content-to-print">
                    <!-- Title -->
                    <h1 id="blog-title"
                        class="font-inter font-semibold pt-2 text-3xl sm:text-2xl md:text-3xl text-gray-900 leading-tight">
                        {{ blog_detail.title }}</h1>

                    <!-- Social icons area -->
                    <div data-aos="fade-up" data-aos-anchor-placement="top-bottom"
                        class="flex flex-col sm:flex-row justify-between items-start sm:items-center font-inter mt-3 border-t border-gray-200 pt-2 space-y-2 sm:space-y-0">
                        <div data-aos="fade-up" data-aos-anchor-placement="top-bottom"
                            class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                            <span>
                                <i class="fa-solid fa-user pr-2"></i>
                                {{ blog_detail.author.first_name }} {{ blog_detail.author.last_name }}
                            </span>
                            <span>
                                <i class="fa-solid fa-eye pt-[5px]"></i>
                                {{ blog_detail.views|humanize_number }}
                            </span>

                            <span class="flex flex-row gap-[5px] pt-1">
                                <svg class="pt-[1px]" width="13" height="20" viewBox="0 0 12 14"
                                    xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M9.51768 8.96851C8.95518 8.96851 8.44393 9.19851 8.07227 9.57018L4.19727 7.36685C4.24893 7.18768 4.2856 7.00185 4.2856 6.80685C4.2856 6.61102 4.24977 6.42518 4.19893 6.2456L8.06143 4.04935C8.43393 4.42602 8.94977 4.66102 9.51768 4.66102C10.661 4.66102 11.5852 3.73643 11.5852 2.60893C11.5852 1.46518 10.661 0.541016 9.51768 0.541016C8.38977 0.541016 7.4656 1.46518 7.4656 2.60893C7.4656 2.78727 7.49602 2.95768 7.53935 3.12352L3.70727 5.37643C3.33143 4.98477 2.80477 4.73935 2.2181 4.73935C1.09018 4.73935 0.166016 5.6631 0.166016 6.80685C0.166016 7.93476 1.09018 8.85851 2.2181 8.85851C2.8006 8.85851 3.32435 8.61726 3.69977 8.23268L7.54602 10.4943C7.49893 10.6681 7.4656 10.8473 7.4656 11.036C7.4656 12.1639 8.38977 13.0881 9.51768 13.0881C10.661 13.0881 11.5852 12.1639 11.5852 11.036C11.5852 9.89268 10.661 8.96851 9.51768 8.96851">
                                    </path>
                                </svg>
                                <span class="font-semibold">{{ blog_detail.shares.count|humanize_number }}</span>
                            </span>
                            <span class="flex flex-row gap-[5px] pt-1">
                                <i class="fa-solid fa-thumbs-up pt-[1px]"></i>
                                <span class="font-semibold">{{ blog_detail.likes.count|humanize_number }}</span>
                            </span>
                        </div>

                        <!-- Social Icons -->
                        <div data-aos="fade-up" data-aos-anchor-placement="top-bottom"
                            class="flex flex-wrap items-center gap-2">
                            <div
                                class="flex w-8 h-8 border rounded-full border-[#1877F2] justify-center items-center hover:bg-[#1877F2] hover:text-white">
                                <a href="#" onclick="shareOnFacebook()" class="text-[#1877F2] hover:text-white">
                                    <i class="fa-brands fa-facebook-f"></i>
                                </a>
                            </div>

                            <div
                                class="flex w-8 h-8 border rounded-full border-[#1DA1F2] justify-center items-center hover:bg-[#1DA1F2] hover:text-white">
                                <a href="#" onclick="shareOnTwitter()" class="text-[#1DA1F2] hover:text-white">
                                    <i class="fa-brands fa-x-twitter"></i>
                                </a>
                            </div>

                            <div
                                class="flex w-8 h-8 border rounded-full border-[#0A66C2] justify-center items-center hover:bg-[#0A66C2] hover:text-white">
                                <a href="#" onclick="shareOnLinkedIn()" class="text-[#0A66C2] hover:text-white">
                                    <i class="fa-brands fa-linkedin-in"></i>
                                </a>
                            </div>

                            <div
                                class="flex w-8 h-8 border rounded-full border-[#25D366] justify-center items-center hover:bg-[#25D366] hover:text-white">
                                <a href="#" onclick="shareOnWhatsApp()" target="_blank"
                                    class="text-[#25D366] hover:text-white">
                                    <i class="fa-brands fa-whatsapp"></i>
                                </a>
                            </div>
                            <div
                                class="flex w-8 h-8 border rounded-full border-gray-400 justify-center items-center hover:bg-gray-500 hover:text-white">
                                <a href="#" class="text-gray-500 hover:text-white" onclick="printBlogContent()">
                                    <i class="fa-solid fa-print"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Blog Image -->
                    <div data-aos="fade-up" data-aos-anchor-placement="top-bottom" class="relative mt-3">
                        <img class="w-full h-auto object-cover rounded-md" src="{{ blog_detail.featured_image_url }}"
                            alt="AI chip" />
                    </div>

                    <!-- Author + Share + Save -->
                    <div data-aos="fade-up" data-aos-anchor-placement="top-bottom"
                        class="mt-2 flex flex-col sm:flex-row items-start sm:items-center justify-between border-b-[1px] border-e-gray-200 space-y-2 sm:space-y-0">
                        <div>
                            <span class="text-blue-600 font-extrabold">
                                TL
                                <span class="text-gray-900 ml-1 font-bold">Techlife Report</span>
                            </span>
                        </div>

                        <div data-aos="fade-up" data-aos-anchor-placement="top-bottom" data-aos-duration="500"
                            class="flex items-center py-1 cursor-pointer">
                            <div
                                class="audio-controls flex items-center gap-2 group rounded-sm px-2 hover:border-blue-500 transition-all duration-500">
                                <button id="main-audio-btn"
                                    class="flex items-center gap-1 border border-gray-300 px-2 rounded-xl"
                                    title="Listen">
                                    <span
                                        class="font-inter text-gray-500 text-[12px] group-hover:text-blue-500 transition-all duration-300">Listen</span>
                                    <span id="icon-display"
                                        class="text-gray-700 text-[16px] group-hover:text-blue-500 animate-float"><i
                                            class="fa-solid fa-microphone"></i></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div data-aos="fade-up" data-aos-anchor-placement="top-bottom"
                        class="flex flex-col sm:flex-row items-start sm:items-center justify-between text-sm text-gray-600 mt-2 space-y-2 sm:space-y-0">
                        <div data-aos="fade-up" data-aos-anchor-placement="top-bottom">
                            <span class="mr-4">Publish : {{ blog_detail.created_at|date:"d, M Y" }}</span>
                            |
                            <span>Update : {{ blog_detail.updated_at|date:"d, M Y" }}</span>
                        </div>

                        <div data-aos="fade-up" data-aos-anchor-placement="top-bottom"
                            class="flex flex-wrap items-center space-x-5 text-gray-600 font-semibold text-[13px] pr-2">
                            <!-- like section -->
                            {% if user_has_liked %}
                            <a hx-get="{% url 'user_like_toggle' like_slug=blog_detail.slug %}" hx-target="#container"
                                hx-swap="innerHTML" hx-push-url="true"
                                class="flex items-center space-x-1 cursor-pointer text-blue-600">

                                <i class="fa-solid fa-thumbs-up"></i>
                                <span>liked</span> </a>
                            {% else %}
                            <a hx-get="{% url 'user_like_toggle' like_slug=blog_detail.slug %}" hx-target="#container"
                                hx-swap="innerHTML" hx-push-url="true"
                                class="flex items-center space-x-1 cursor-pointer hover:text-blue-500">

                                <i class="fa-solid fa-thumbs-up"></i>
                                <span>Like</span>
                            </a>
                            {% endif %}

                            <!-- Share Button -->
                            <span id="shareBtn" class="flex items-center space-x-1 cursor-pointer hover:text-gray-800">

                                <svg class="pt-[1.5px]" width="14" height="18" viewBox="0 0 12 14"
                                    xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M9.51768 8.96851C8.95518 8.96851 8.44393 9.19851 8.07227 9.57018L4.19727 7.36685C4.24893 7.18768 4.2856 7.00185 4.2856 6.80685C4.2856 6.61102 4.24977 6.42518 4.19893 6.2456L8.06143 4.04935C8.43393 4.42602 8.94977 4.66102 9.51768 4.66102C10.661 4.66102 11.5852 3.73643 11.5852 2.60893C11.5852 1.46518 10.661 0.541016 9.51768 0.541016C8.38977 0.541016 7.4656 1.46518 7.4656 2.60893C7.4656 2.78727 7.49602 2.95768 7.53935 3.12352L3.70727 5.37643C3.33143 4.98477 2.80477 4.73935 2.2181 4.73935C1.09018 4.73935 0.166016 5.6631 0.166016 6.80685C0.166016 7.93476 1.09018 8.85851 2.2181 8.85851C2.8006 8.85851 3.32435 8.61726 3.69977 8.23268L7.54602 10.4943C7.49893 10.6681 7.4656 10.8473 7.4656 11.036C7.4656 12.1639 8.38977 13.0881 9.51768 13.0881C10.661 13.0881 11.5852 12.1639 11.5852 11.036C11.5852 9.89268 10.661 8.96851 9.51768 8.96851">
                                    </path>
                                </svg>
                                <span>Share</span>
                            </span>
                            <div id="share-data-container" style="display:none;" data-post-id="{{ blog_detail.id }}"
                                data-share-url="{% url 'share_post' %}" data-csrf-token="{{ csrf_token }}">
                            </div>

                            {% comment %} save funtion {% endcomment %}
                            <!-- Save Button -->

                            <!-- Save Button -->
                            <span
                                x-data="saveModalHandler({{ blog_detail.id }}, {{ user.is_authenticated|yesno:'true,false' }})">

                                <span @click="checkAndOpen()"
                                    class="flex items-center space-x-1 cursor-pointer hover:text-gray-800">
                                    <span>Save</span>
                                    <svg width="14" height="20" viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg"
                                        fill="currentColor">
                                        <path
                                            d="M5.99996 9.43351L9.46496 11.0741L9.46496 2.0125L2.53496 2.0125L2.53496 11.0741L5.99996 9.43351ZM0.959961 13.5625L0.959961 0.4375L11.04 0.4375L11.04 13.5625L5.99996 11.1761L0.959961 13.5625Z" />
                                    </svg>
                                </span>

                                <!-- Modal + Toast -->
                                <template x-teleport="body">
                                    <!-- Modal -->
                                    <div x-show="modalOpen" x-cloak
                                        class="fixed inset-0 z-[99] flex items-center justify-center w-screen h-screen">
                                        <div @click="modalOpen=false" x-transition.opacity
                                            class="absolute inset-0 w-full h-full bg-black/50 backdrop-blur-sm"></div>
                                        <div x-show="modalOpen" x-trap.inert.noscroll x-transition.scale
                                            class="relative bg-white rounded-xl p-6 w-80 shadow-lg sm:max-w-lg">
                                            <h2 class="text-xl font-bold mb-4 text-gray-800"
                                                x-text="userAuthenticated ? 'Save for later' : 'Sign in to save for later'">
                                            </h2>
                                            <div class="flex justify-end gap-3">
                                                <template x-if="userAuthenticated">

                                                    <div class=>
                                                        <button type="button" @click="modalOpen=false"
                                                            class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>

                                                        <button type="submit"
                                                            class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">OK</button>
                                                    </div>

                                                </template>
                                                <template x-if="!userAuthenticated">
                                                    <div class="flex gap-3">
                                                        <!-- Sign In Button -->
                                                        <a href=""
                                                            class="px-4 py-2 rounded-md bg-blue-600 text-white font-medium shadow-sm hover:bg-blue-700 transition-colors duration-200">Sign
                                                            In</a>

                                                        <!-- Register Button -->
                                                        <a href=""
                                                            class="px-4 py-2 rounded-md bg-green-600 text-white font-medium shadow-sm hover:bg-green-700 transition-colors duration-200">Register</a>
                                                    </div>
                                                </template>
                                            </div>
                                            <button @click="modalOpen=false"
                                                class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                                        </div>
                                    </div>

                                    <!-- Toast -->
                                    <div x-show="toastOpen" x-transition
                                        class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-3 rounded shadow-lg z-50">
                                        <span x-text="toastMessage"></span>
                                    </div>
                                </template>
                            </span>
                        </div>
                    </div>

                    <!-- Blog Description -->
                    <div data-aos="fade-up" data-aos-anchor-placement="top-bottom" id="blog-description"
                        class="article-body mt-6 space-y-5 text-gray-800 font-serif-custom">
                        <p>{{ blog_detail.description|linebreaksbr }}</p>
                    </div>
                </div>

                <!--  Comment Section -->
                <section id="comments" class="mt-12 border-t border-gray-200 pt-8 font-inter">
                    <!-- Header - Mobile Optimized -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h2
                            class="text-lg sm:text-xl font-bold text-gray-700 text-center sm:text-left w-full sm:w-auto">
                            Total Comments ({{ total_comments|humanize_number }})
                        </h2>

                        <!-- Sort dropdown -->
                        <!-- Sort dropdown - Only show if user is authenticated -->
                        {% if user.is_verified %}
                        <div class="relative w-full sm:w-48">
                            <form method="GET" action=".">
                                <select name="sort_by" id="sort-comments" onchange="this.form.submit()"
                                    class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none cursor-pointer appearance-none bg-white shadow-sm">
                                    <option value="newest" {% if sort_by == "newest" %}selected{% endif %}>Newest First
                                    </option>
                                    <option value="oldest" {% if sort_by == "oldest" %}selected{% endif %}>Oldest
                                    </option>
                                    <option value="recent" {% if sort_by == "recent" %}selected{% endif %}>Recently
                                        Updated</option>
                                </select>
                                <div
                                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </form>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Comment Form - Mobile Optimized -->
                    {% if user.is_verified %}
                    <form method="POST" hx-post="{% url 'add_comment' post_slug=blog_detail.slug %}"
                        hx-target="#container" hx-swap="innerHTML" hx-push-url="true" class="flex gap-3 mb-6">
                        {% csrf_token %}
                        <img src="{{ request.user.profile_picture.url }}" alt="User"
                            class="w-10 h-10 rounded-full border border-gray-300 flex-shrink-0 object-cover" />
                        <div class="flex-1">
                            <div class="flex items-center gap-2 bg-white border border-gray-300 rounded-full px-4 py-2">
                                <textarea name="content" rows="1" placeholder="Write a comment..."
                                    class="w-full py-2 text-sm focus:outline-none resize-none placeholder-gray-500"></textarea>
                                <button type="submit"
                                    class="flex items-center justify-center w-8 h-8 bg-blue-500 text-white rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6 text-center">
                        <p class="text-gray-600 text-sm">
                            Please <a href="{% url 'login' %}" class="text-blue-500 font-medium">sign in</a> to comment.
                        </p>
                    </div>
                    {% endif %}

                    <!-- Comment List -->
                    <div id="comment-list" class="space-y-6">
                        {% for comment in all_comments %}
                        <div class="flex flex-col sm:flex-row gap-3 bg-white rounded-md p-4 shadow-sm transition-all">
                            <!-- User Avatar -->
                            <img src="{{ comment.user.profile_picture.url }}" alt="User"
                                class="w-10 h-10 rounded-full border flex-shrink-0" />

                            <!-- Comment Content -->
                            <div class="flex-1">
                                <!-- Header -->
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-1 gap-2">
                                    <!-- Name and time inline -->
                                    <div class="flex items-center gap-5">
                                        <h3 class="font-semibold text-gray-800 text-sm">{{ comment.user.first_name }}
                                            {{ comment.user.last_name }}</h3>

                                        <!-- Time ago with green icon -->
                                        <span class="flex items-center gap-1 text-xs text-gray-500 pt-1">
                                            <span class="w-2 h-2 bg-green-500 rounded-full inline-block"></span>
                                            {{ comment.created_at|timesince|slice:":10" }} ago
                                        </span>
                                    </div>
                                </div>

                                <!-- Body -->
                                <p class="text-gray-700 text-sm leading-relaxed">{{ comment.content }}</p>

                                <!-- Actions -->
                                <div class="flex items-center gap-4 text-xs text-gray-500 mt-2">
                                    <button class="hover:text-blue-600 font-medium">Like</button>
                                    <button type="button" class="hover:text-blue-600 font-medium reply-btn"
                                        data-comment-id="{{ comment.id }}">Reply</button>
                                </div>

                                <!-- Reply Form -->
                                <!-- Reply Form - Mobile Optimized -->
                                <form method="POST" hx-post="{% url 'add_reply' comment_id=comment.id %}"
                                    hx-target="#container" hx-swap="innerHTML" hx-push-url="true"
                                    class="hidden reply-form mt-3 flex gap-2 items-center">
                                    {% csrf_token %}
                                    <img src="{{ request.user.profile_picture.url }}"
                                        class="w-8 h-8 rounded-full border border-gray-300 flex-shrink-0" />
                                    <div
                                        class="flex-1 flex items-center gap-2 bg-white border border-gray-300 rounded-full px-3 py-1">
                                        <textarea name="content" rows="1" placeholder="Write a reply..."
                                            class="flex-1 py-2 text-sm focus:outline-none resize-none placeholder-gray-500 bg-transparent"></textarea>
                                        <button type="submit"
                                            class="flex items-center justify-center w-8 h-8 bg-blue-500 text-white rounded-full flex-shrink-0">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                                            </svg>
                                        </button>
                                    </div>
                                </form>

                                <!-- Replies -->
                                {% if comment.replies.all %}
                                <div class="mt-4 ml-6 sm:ml-10 space-y-3">
                                    {% for reply in comment.replies.all %}
                                    <div class="flex gap-3">
                                        <img src="{{ reply.user.profile_picture.url }}"
                                            class="w-8 h-8 rounded-full border" />
                                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-3 flex-1">
                                            <div class="flex justify-between items-center mb-1">
                                                <h4 class="font-semibold text-gray-800 text-sm">
                                                    {{ reply.user.first_name }}</h4>
                                                <span
                                                    class="text-xs text-gray-500">{{ reply.created_at|date:"d M Y, h:i A" }}</span>
                                            </div>
                                            <p class="text-gray-700 text-sm">{{ reply.content }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 italic text-center">No comments yet. Be the first to comment!</p>
                        {% endfor %}

                        {% if all_comments.has_next %}
                        <div class="text-center mt-6" id="load-more-container">
                            <button hx-get="?page={{ all_comments.next_page_number }}&sort_by={{ sort_by }}"
                                hx-target="#container"
                                class="inline-block px-6 py-2 border border-blue-500 text-blue-500 rounded-full hover:bg-blue-50 transition duration-300">
                                See More ({{ all_comments.paginator.count }})
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </section>
            </div>
        </main>

        <!-- Vertical Divider - Hidden on mobile -->
        <div class="hidden lg:block w-px h-auto bg-gray-200 mx-4"></div>

        <!-- Sidebar -->
        <aside class="w-full lg:w-1/4 mt-8 lg:mt-0">
            <div class="mb-8">
                <div>
                    <h2 class="text-xl font-bold text-gray-900 mb-3 font-inter">Related News</h2>
                </div>
                <div class="flex flex-col mb-4">
                    <div class="absolute w-24 h-1 bg-blue-600"></div>
                    <div class="w-full h-px bg-gray-300"></div>
                </div>

                {% for news in related_news|slice:":8" %}
                <a hx-get="{% url 'blog_details' news.slug %}" hx-target="#container" hx-swap="innerHTML"
                    hx-push-url="true"
                    class="flex items-start mb-4 border-b border-gray-100 pb-3 group last:border-b-0">
                    <div
                        class="w-20 h-16 min-w-20 flex-shrink-0 overflow-hidden rounded-md transform transition-transform duration-300 group-hover:scale-105">
                        <img class="w-full h-full object-cover" src="{{ news.featured_image_url }}"
                            alt="{{ news.title }}" />
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <p
                            class="text-sm text-gray-800 group-hover:text-blue-600 cursor-pointer line-clamp-2 leading-tight">
                            {{ news.title }}</p>
                        <span class="text-xs text-gray-500 mt-1 block">{{ news.created_at|date:"d M Y, h:i A" }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>

            <div class="pt-6 border-t border-gray-200">
                <div>
                    <h2 class="text-xl font-bold text-gray-900 mb-3 font-inter">Most Viewed</h2>
                </div>
                <div class="flex flex-col mb-4">
                    <div class="absolute w-24 h-1 bg-blue-600"></div>
                    <div class="w-full h-px bg-gray-300"></div>
                </div>

                {% for news in most_viewed_blogs|slice:":8" %}
                <div hx-get="{% url 'blog_details' news.slug %}" hx-target="#container" hx-swap="innerHTML"
                    hx-push-url="true"
                    class="flex items-start mb-4 border-b border-gray-100 pb-3 group last:border-b-0 cursor-pointer">
                    <div
                        class="w-20 h-16 min-w-20 flex-shrink-0 overflow-hidden rounded-md transform transition-transform duration-300 group-hover:scale-105">
                        <img class="w-full h-full object-cover" src="{{ news.featured_image_url }}"
                            alt="{{ news.title }}" />
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <p class="text-sm text-gray-800 group-hover:text-blue-600 line-clamp-2 leading-tight">
                            {{ news.title }}</p>
                        <span class="text-xs text-gray-500 mt-1 block">{{ news.created_at|date:"d M Y, h:i A" }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </aside>
    </div>
</div>

<!-- print funtion -->
<script>
    function printBlogContent() {
        const contentToPrint = document.getElementById('blog-content-to-print').innerHTML;
        const originalContent = document.body.innerHTML;
        document.body.innerHTML = contentToPrint;
        window.print();
        document.body.innerHTML = originalContent;
    }
</script>

<!-- audio control -->
<script>
    let speech = null;
    const titleElement = document.getElementById('blog-title');
    const descriptionElement = document.getElementById('blog-description');
    const mainAudioBtn = document.getElementById('main-audio-btn');
    const stopBtn = document.getElementById('stop-btn');
    const iconDisplay = document.getElementById('icon-display');
    const synth = window.speechSynthesis;

    function updateUI(isSpeaking, isPaused) {
        if (!iconDisplay || !mainAudioBtn || !stopBtn) return;
        const micIconHTML = '<i class="fa-solid fa-microphone"></i>';
        if (isSpeaking) {
            if (isPaused) {
                iconDisplay.innerHTML = micIconHTML;
                mainAudioBtn.title = 'Resume';
            } else {
                iconDisplay.innerHTML = micIconHTML;
                mainAudioBtn.title = 'Pause';
            }
            stopBtn.disabled = false;
        } else {
            iconDisplay.innerHTML = micIconHTML;
            mainAudioBtn.title = 'Listen';
            stopBtn.disabled = true;
        }
    }
    mainAudioBtn.addEventListener('click', () => {
        if (synth.paused) {
            synth.resume();
            updateUI(true, false);
            return;
        }
        if (synth.speaking) {
            synth.pause();
            updateUI(true, true);
            return;
        }
        const titleText = titleElement ? titleElement.textContent : '';
        const descriptionText = descriptionElement ? descriptionElement.textContent : '';
        // টাইটেল, তারপর একটি বিরামচিহ্ন (যেমন পূর্ণচ্ছেদ বা কোলন) এবং ডেসক্রিপশন যোগ করা
        const textToSpeak = titleText + '. ' + descriptionText;
        if (!textToSpeak.trim()) {
            console.warn('No text content found to speak.');
            return;
        }
        speech = new SpeechSynthesisUtterance(textToSpeak);
        speech.lang = 'bn-BD';
        synth.speak(speech);
        updateUI(true, false);
        speech.onend = () => {
            updateUI(false, false);
        };
        speech.onerror = (event) => {
            console.error('Speech synthesis error:', event);
            updateUI(false, false);
        };
    });
    stopBtn.addEventListener('click', () => {
        if (synth.speaking || synth.paused) {
            synth.cancel();
            updateUI(false, false);
        }
    });
    // Initial state set করা
    updateUI(false, false);
</script>

{% comment %} save sectioin {% endcomment %}

<script>
    function saveModalHandler(postId, userAuthenticated) {
        return {
            modalOpen: false,
            toastOpen: false,
            toastMessage: '',
            postId: postId,
            userAuthenticated: userAuthenticated,
            checkAndOpen() {
                if (!this.userAuthenticated) {
                    this.modalOpen = true;
                    return;
                }
            },
        };
    }
</script>

{% comment %} reply button toggle reply form {% endcomment %}
<script>
    document.querySelectorAll('.reply-btn').forEach((btn) => {
        btn.onclick = function(e) {
            e.preventDefault();
            const form = this.closest('div').parentNode.querySelector('.reply-form');
            if (form) {
                form.classList.toggle('hidden'); // 'hidden' ক্লাস টগল করা
            } else {
                console.warn("Reply form not found for this button.");
            }
        };
    });
</script>

<!-- for share -->
<!-- for share -->
<!-- for share -->

<!-- for share -->
{% if blog_detail.slug %}
<!-- FIX: post.slug er bodole blog_detail.slug use kora holo -->
<script>
    // Helper function to get the CSRF token (required for Django POST requests)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const SHARE_URL = "{% url 'record_share' post_slug=blog_detail.slug %}";
    const PAGE_URL = window.location.href;
    const SHARE_TEXT = document.title;

    function openShareWindow(url) {
        window.open(url, 'share-dialog', 'width=626,height=436,toolbar=0,menubar=0,scrollbars=yes');
        return false;
    }
    // New function to record the share using AJAX (Fetch API)
    function recordShare(platform) {
        fetch(SHARE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `platform=${platform}`
            })
            .then(response => response.json())
            .then(data => {
                console.log(`Share Status (${platform}):`, data.message);
            })
            .catch(error => {
                console.error('Error recording share:', error);
            });
    }

    function shareOnFacebook() {
        const facebookUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(PAGE_URL);
        openShareWindow(facebookUrl);
        recordShare('facebook');
    }

    function shareOnTwitter() {
        const twitterUrl = 'https://twitter.com/intent/tweet?url=' + encodeURIComponent(PAGE_URL) + '&text=' +
            encodeURIComponent(SHARE_TEXT);
        openShareWindow(twitterUrl);
        recordShare('twitter');
    }

    function shareOnLinkedIn() {
        const linkedinUrl = 'https://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(PAGE_URL) +
            '&title=' + encodeURIComponent(SHARE_TEXT);
        openShareWindow(linkedinUrl);
        recordShare('linkedin');
    }

    function shareOnWhatsApp() {
        const whatsappUrl = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(SHARE_TEXT) + ' ' +
            encodeURIComponent(PAGE_URL);
        window.open(whatsappUrl, '_blank');
        recordShare('whatsapp');
    }
</script>
{% endif %}